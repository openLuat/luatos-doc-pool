## 1. 有没有免费的MQTT broker可用
>合宙有一个lbsmqtt.airm2m.com:1884的broker，没有网页端控制页面，可以用模块和mqtt.fx客户端配合测试。

## 2. 连接服务器失败
>1、检查下模块信号、网络注册、网络附着、PDP激活状态。<br>
>2、检查下SIM卡是否欠费【4G模块有一种欠费表现：无法注册4G网络，可以注册2G网络】。<br>
>3、使用mqtt.fx，连接服务器确认一下是否可以连接成功，排除服务器故障。<br>
>4、部分国外的开源项目提供免费的MQTT代理服务器，因为网络的原因，国内存在严重的延迟或者丢包现象，导致程序运行出现问题。<br>
>5、确认是不是域名解析失败导致，可以通过AT+CDNSGIP=<domain name>确认一下域名是否能正常解析（注意：该命令只有在执行完at+cstt、at+ciicr、at+cifsr后才能正常工作），不能正常解析，可以通过AT+CDNSCFG=ip1,ip2设置域名解析服务器。<br>
>6、在 MIPSTART /SSLMIPSTART返 回 CONNECT OK后 才 能 发 MCONNECT命令，而且要立即发，否则会被服务器踢掉。

## 3. 频繁掉线是什么原因
>1、检查下是否存在代码逻辑错误，导致异常。<br>
>2、检查下是否不断重启，导致异常。<br>
>3、检查下服务器网络是否稳定，不要用内网穿透方式搭建服务器。<br>
>4、检查下使用环境是否网络覆盖不好，例如车库、地下、电梯、山区等。<br>
>5、检查下模块信号、网络注册、网络附着、PDP激活状态。<br>
>6、排查是否为设备天线问题：发出来设备的天线调试指标参数给合宙技术支持人员；曾经有一个客户天线指标明显有问题，导致10几个小时出现30次左右掉线；后来重新调试天线之后，40个小时出现几次掉线。<br>
>7、如果经常出现连接被动断开：
  1) 检查下mqtt keep alive的时间，一般建议使用2分钟【如果每2分钟内都有应用数据收发，则可以把mqtt keep alive的时间设置的长一点儿】，除非有强制要求，否则不能太长，也不能太短。不建议超过4分钟，基站策略会关闭长时间没有数据传输的连接，太长时间可能会导致连接被基站关闭；不建议少于1分钟，太短时间可能会因为网络环境波动导致上行数据发送超时，可能超过1.5倍的心跳时间，从而被服务器主动断开连接。<br>
  2) 检查下是否在1.5倍的mqtt keep alive的时间，没有成功发送数据到服务器，就会被被服务器主动断开，这种情况一般都是发送数据超时引起的。<br>
8、如果要降低掉线率，可通过如下方式设置【注意：在网络环境不变的情况下，降低掉线率意味着会增加响应延时】
A. mqtt keep alive的时间，一般建议使用2分钟【如果每2分钟内都有应用数据收发，则可以把mqtt keep alive的时间设置的长一点儿】，除非有强制要求，否则不能太长，也不能太短。不建议超过4分钟，基站策略会关闭长时间没有数据传输的连接，太长时间可能会导致连接被基站关闭；不建议少于1分钟，太短时间可能会因为网络环境波动导致上行数据发送超时，可能超过1.5倍的心跳时间，从而被服务器主动断开连接。<br>
B. 减少Qos1和Qos2的publish使用，允许的话建议都使用Qos0。<br>

## 4. 排查是否设备单体问题：如果同一地点，某些设备正常，某些设备异常，按照如下几种情况分析
>1、分析正常设备和异常设备的使用环境是否相同：
>A. 如果不同，例如异常设备固定在钢制墙壁上，正常设备放置在桌子上，钢制墙壁可能对天线射频有干扰，将异常设备和正常设备放置在同样的使用环境中，再对比测试。
>B. 如果相同，参考第2)步。<br>
>2、 分析正常和异常的设备，驻留的小区是否相同：
>A. 如果相同，重点排查异常设备的天线射频部分，分析不出结果的话，异常设备寄给合宙分析。
>B. 如同不同，多测试几次，确认下，是不是在异常小区内很容易出问题，如果异常小区很容易出问题，可能就是小区拥堵造成的。


## 5. 有没有认证机制
>有，每个设备有clientid、username、password。

## 6. client id是否允许重复
>不允许重复，重复的话，服务器会踢掉上一个相同id的设备。

## 7.  Qos0、1、2如何选择
>应用允许的情况下，建议使用Qos0，Qos1和Qos2会加重网络负担，4G网络还好，特别是2G网络，在网络拥堵和较差的情况下，数据传输的次数越多，掉线的概率就会越高。

## 8.  数据接收缓存问题
>可通过AT+MQTTMSGSET命令设置是否缓存，详情参考AT手册。
>1、不缓存：通过AT+MQTTMSGSET=0设置；收到订阅的publish报文后，立即通过AT口输出主题、payload长度、payload内容，每个报文中支持的payload内容最大1360字节。
>2、内存缓存：通过AT+MQTTMSGSET=1设置；内存中有一个缓存表，最多支持缓存4条publish报文；收到订阅的publish报文后，插入缓冲表中的空闲位置，然后通过AT口输出存储位置；缓存表满之后，新收到的publish报文会覆盖最旧的publish报文。
>注意：缓存表位于内存中，断电或者重启后，缓存表中的数据会被清空；建议收到数据时，通过AT+MQTTMSGGET及时读取出来，以防缓冲区满覆盖丢失数据。

## 9. 是否支持ssl
>支持证书配置，支持单向认证和双向认证
>支持如下六种加密套件：
>0X0035 TLS_RSA_WITH_AES_256_CBC_SHA
>0X002F TLS_RSA_WITH_AES_128_CBC_SHA
>0X0005 TLS_RSA_WITH_RC4_128_SHA
>0X0004 TLS_RSA_WITH_RC4_128_MD5
>0X000A TLS_RSA_WITH_3DES_EDE_CBC_SHA
>0X003D TLS_RSA_WITH_AES_256_CBC_SHA256

## 10. 为什么mqtt ssl访问失败
>1、检查服务器是否支持模块支持的加密套件。<br>
>2、发日志文件给合宙技术支持人员分析。<br>

## 11. MQTT支持多连接吗
>目前MQTT仅支持单连接，不支持多连接。

## 12. MQTT的遗嘱如何使用
>通过AT+MCONFIG命令可以设置遗嘱的qos、retain标志、topic、payload；在如下几种（包含但是又不仅限于如下情况）情况下，服务器会主动发布遗嘱消息到订阅的客户端：
>1、模块和服务器通信异常（例如模块突然关机、模块进入了一个没有网络信号的环境等）超过1.5倍（一般是1.5倍，但不排除服务器可以修改这个时间）的 keep alive时间（可以通过AT+MCONNECT设置keep alive时间）。<br>
>2、模块主动执行AT+MDISCONNECT或者AT+MIPCLOSE。

## 13. MQTT SSL如何使用
>参考AT手册MQTT章节下《使用方法举例》中的"SSL带证书验证流程"使用方法；支持的SSL参数，请参考AT+SSLCFG命令说明。

## 14. 重试多次PDP，MQTT应用一直连接失败
>如果重试多次PDP激活，PDP一直激活失败，或者MQTT一直连接失败，则尝试使用如下手段恢复：
>1、使用RESET引脚复位模块。<br>
>2、极端情况下，直接给模块断电，再上电，POWER KEY引脚拉低开机。<br>

## 15. MPUB命令中，payload包含"如何发送？
>1、消息中内嵌的双引号请用\22 表达；控制字符回车\r(0x0D) 请用\0D 表达； ； 控制字符换行\n（0x0A ）请用\0A 表达 ； 控制字符反斜杠\ （0x5C ） 请用\5C表达。<br>
>2、如果是 MCU 发消息，可能需要用\\\22 ，\\\0D ，\\\0A ，\\\5C 来表达，即\ 需要转义成\\\ 。

## 16. 如何实现掉线自动重连
>参考mqtt demo，实现自动重连即可。

## 17. mqtt.client() version MQTT版本号"3.1.1",“3.1”,"5.0"都支持吗
>支持3.1和3.1.1。

## 18.Air724模块Lua开发数据接收缓存问题
>内存中有一个缓存表，在项目剩余可用内存的范围内，此缓存表没有大小限制，例如项目可用内存剩余200KB，则此缓存表的理想最大值是200KB；收到的publish报文都会缓存到此缓存表，如果收到的数据超过缓存表大小，会导致内存不足重启；需要读取数据时，通过mqtt:receive接口主动读取即可。<br>
>注意：缓存表位于内存中，断电或者重启后，缓存表中的数据会被清空；虽然缓存表可以缓存很多数据，但是建议收到数据时，还是要及时读取出来；缓存表不断缓存数据，会占用大量内存，在项目内存紧张的情况下，很容易出现内存不足问题导致重启。

## 19.Air724做的mqtt客户端，有什么mqtt服务器调试工具吗，就是用来收发数据调试的
>可以通过MQTT.fx工具来测试mqtt运行状况。

## 20. AT版本MQTT支持多连接吗
>目前MQTT仅支持单连接，不支持多连接。

## 21. AT版本MQTT的遗嘱如何使用

> 通过AT+MCONFIG命令可以设置遗嘱的qos、retain标志、topic、payload；在如下几种（包含但是又不仅限于如下情况）情况下，服务器会主动发布遗嘱消息到订阅的客户端：
> 1、模块和服务器通信异常（例如模块突然关机、模块进入了一个没有网络信号的环境等）超过1.5倍（一般是1.5倍，但不排除服务器可以修改这个时间）的 keep alive时间（可以通过AT+MCONNECT设置keep alive时间）。
>
> 2、模块主动执行AT+MDISCONNECT或者AT+MIPCLOSE。
