## 1. 如何连接阿里云
>参考AT应用开发指南：[连阿里云应用指南](https://doc.openluat.com/wiki/27?wiki_page_id=3255 "连阿里云应用指南")
>
>4G模块LuatOS-Air版本：参考aLiYun的demo和doc文档应用开发指南aLiYun章节。

## 2. 除了阿里云，支持华为云、百度云、腾讯云、OneNet等其他云平台吗
>OneNet，CTWing参考DOC文档AT应用开发指南下对应的章节。

## 3. 一型一密方案，设备在线运行了很多天后，模块中的设备密钥和阿里云平台上的密钥不一致导致无法上线
>1、有一个客户陆续反映此问题，目前还没有定位到根本原因，可按照如下方式协助确认此问题：
>首先从阿里云平台导出所有设备的密钥保存下来，然后设备复现此问题后，对比一下模块中的设备密钥和本地保存的密钥是否一致：如果不一致，就是模块端的问题；如果一致，就是阿里云平台端的问题。【注意：必须在设备正常在线状态下，从阿里云平台导出密钥保存下来，设备复现问题后，对比才有意义；如果设备已经复现问题，再从阿里云平台导出密钥对比，没有意义】。<br>
>2、在脚本中增加一个辅助保存设备密钥的功能：连接阿里云成功后，将设备密钥保存到nvm中，复现问题后，对比nvm中的密钥和sn中存储的密钥是否一致。<br>
>3、在定位出根本原因之前，可通过如下方式规避处理：在阿里云上删除此设备，然后再重新录入。

## 4. 为什么阿里云连接失败
>1、确认下product key中的大小写是否正确，连接阿里云服务器时，会用到这个product key，大小写敏感，大小写出错会导致域名解析失败。<br>
>2、默认使用模块imei作为client id连接阿里云，从日志中确认下实际imei和模块标签上的imie是否一致，如果不一致，可能模块没写imei。

## 5. 如何降低阿里云的离线率
>1、mqtt keep alive的时间，一般建议使用2分钟【如果每2分钟内都有应用数据收发，则可以把mqtt keep alive的时间设置的长一点儿】，除非有强制要求，否则不能太长，也不能太短。不建议超过4分钟，基站策略会关闭长时间没有数据传输的连接，太长时间可能会导致连接被基站关闭；不建议少于1分钟，太短时间可能会因为网络环境波动导致上行数据发送超时，可能超过1.5倍的心跳时间，从而被服务器主动断开连接。<br>
>2、 减少Qos1和Qos2的publish使用，允许的话建议都使用Qos0。

## 6. 阿里云网站上的异常信息和模块动作的对应关系
| 阿里云网站异常信息        | 模块动作                                                     |
| ------------------------- | ------------------------------------------------------------ |
| Device disconnect         | 发送了disconnect报文，可能是逻辑问题，导致异常发送了disconnect报文，需要脚本日志文件分析 |
| Connectoin reset by peer  | 模块发送超时失败，没有断开mqtt连接，直接断开了socket【可参考问题5优化】 |
| keepalive timeout         | 模块发送mqtt心跳超时，被服务器断开【可参考问题5优化】        |
| kicked by the same device | 有两种可能性：<br><br>1、存在相同client id的设备，默认使用模块imei作为client id，可能是imei重复，可参考IMEI、SN问题章节确认下是否模块imei为默认值<br><br>2、设备在线状态下，发生了重启，重启后成功连接阿里云 |

## 7. 如何批量写入三元组
>一机一密的三元组信息为：ProductKey、DeviceName、DeviceSecret
>一型一密的三元组信息为：ProductKey、ProductSecret、DeviceName
>ProductKey和ProductSecret可以直接固化在代码中。
>DeviceName建议直接使用模块的IMEI，也可以使用MCU端的一个唯一ID，只要这个ID在同一个ProductKey下是唯一的即可。
>DeviceSecret的批量写入，详细说明如下：
>一机一密，有如下两种方式：
>1、在工厂烧录固件时，上位机通过模块uart口将DeviceSecret写入到模块中【强烈建议存储在模块sn中，参考IMEI、SN问题章节，如果mcu端可以存储，也可以存储在mcu端】。
>2、 终端设备第一次开机运行时，连接自建的服务器，将ProductKey和DeviceName上传给自建服务器，自建服务器访问阿里云获取对应的DeviceSecret，然后将DeviceSecret下发给终端设备存储【强烈建议存储在模块sn中，参考IMEI、SN问题章节，如果mcu端可以存储，也可以存储在mcu端】。
>一型一密：在连接阿里云过程中，终端设备会自动动态注册，注册成功后，阿里云服务器会返回对应的DeviceSecret给终端设备，终端设备存储起来即可【强烈建议存储在模块sn中，参考IMEI、SN问题章节，如果mcu端可以存储，也可以存储在mcu端】；之后再去连接阿里云，不需要再次动态注册，因为阿里云仅允许动态注册一次，重复注册会返回错误。
