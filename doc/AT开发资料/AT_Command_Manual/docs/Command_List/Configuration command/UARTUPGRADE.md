## 串口升级：AT+UARTUPGRADE

**注：本章命令仅适用于EC618平台系列模块（Air780E系列）>=1155版本支持（目前只有标准AT和LPAT固件支持这个串口指令升级**

语法规则：

| 命令类型 | 语法                                                 | 返回                                                         | 说明                                  |
| -------- | ---------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------- |
| 设置命令 | AT+UARTUPGRADE=<cmd>[,<sn>,<nbytes>,<data>,<xor8sum> | 响应 OK 如果发生错误，响应： ERROR OR +CME ERROR: <err>      | 最大响应时间：10S参数保存模式：不保存 |
| 测试命令 | AT+UARTUPGRADE=?                                     | 响应 +UARTUPGRADE: 列举所支持的 <cmd>OK 如果发生错误，响应： ERROR OR +CME ERROR: <err> |                                       |

 

参数定义：

| 参数      | 定义                                                         | 取值     | 对取值的说明                                                 |
| --------- | ------------------------------------------------------------ | -------- | ------------------------------------------------------------ |
| <cmd>     |                                                              | 0        | 擦除FLASH中FOTA下载区                                        |
| 1         | 分段下载差分文件，且分段是按顺序依次下载参数 <sn>,<nbytes>,<data>,<xor8sum>仅在此指令下生效 |          |                                                              |
| 2         | 验证差分文件校验会返回的状态码XOTA_PS_PKG_UNFOUND		 未写入或已开始写入差分包XOTA_PS_PKG_UNVERIFIED	 差分包写入完成但还未完成校验XOTA_PS_PKG_VERIFIED	 校验差分包成功XOTA_PS_PKG_VERIFAILED  校验失败XOTA_PS_PKG_UPGRADED	 升级完成/升级结束XOTA_PS_PKG_UNDEF		<br>XOTA_PS_PKG_PARTIAL		 其他错误 +UARTUPGRAE ERROR: <err_code><br>1 参数错误<br>2 指令不支持<br>3 文件大小不正确<br>4 sn分段编号不是以0开头或分段编号不连续<br>5 crc校验失败<br>6 没有擦除FLASH下载区 <br>7 擦除Flash下载区域失败<br>8 文件写入失败<br>9 文件读取失败<br>10 区域中没有找到文件（文件写入失败） |          |                                                              |
| 3         | 查询差分文件名称                                             |          |                                                              |
| 4         | 查询差分文件版本号                                           |          |                                                              |
| 5         | 升级差分文件                                                 |          |                                                              |
| <sn>      | 差分文件分段编号                                             | 0- 65535 | 起始编号为0，后续分段依次加1                                 |
| <nbytes>  | 分段数据<data>的总字节数                                     | 4-1024   | 为4字节的整数倍；如果不是 末尾补0，直到是4的整数倍           |
| <data>    | 差分文件分段数据                                             | 8-2048   | 以16进制可显示字符表示的差分文件分段数据，数据长度为<nbytes>的2倍，差分文件通过FotaToolkit工具生成 |
| <xor8sum> | 差分文件分段数据的XOR8运算值（BCC校验）                      |          | 以16进制可显示字符表示的差分文件分段数据的XOR8运算值（BCC校验），在线计算网站：https://www.lddgo.net/encrypt/bcc |

 

举例：

| 命令（→）/  返回（←） | 实例                                                         | 解释和说明                                                   |
| --------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| →                     | AT+UARTUPGRADE=0                                             | 擦除FLASH中FOTA下载区                                        |
| ←                     | OK                                                           |                                                              |
| →                     | AT+UARTUPGRADE=1,0,1024,ECDF2040000000807B17000013D739771489369C1B8C99236063348853D2C51279344F6641D8134592F8A474FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF4070004927170000000000000040020054332400543324009D2D5B315D380A7D9660A3B51D0B3FDC8A22ED3F91578800FE3D5FB670D5C60A032400008829B1FF001D8B19A38FED67D70F8A14EE85BA47C7183CD845C4DFB31E3E06E0001445433631385F41502E7061720000000000004250484449000000543324004E6F724F4B0000004B0000004B0000004B0000004B000000630000004B0000004B0000004B0000004F0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004B0000004F0000004253444946463430010000004B00000000800000425A6831314159265359C831E0EA0000C440C0C800000440000008200030CD00549A9EA7B00EA901AD206E01F177245385090C831E0EA04253444946463430010000004B00000000800000425A6831314159265359C831E0EA0000C440C0C800000440000008200030CD00549A9EA7B00EA901AD206E01F177245385090C831E0EA04253444946463430010000004B00000000800000425A6831314159265359C831E0EA0000C440C0C800000440000008200030CD00549A9EA7B00EA901AD206E01F177245385090C831E0EA04253444946463430010000004B00000000800000425A6831314159265359C831E0EA0000C440C0C800000440000008200030CD00549A9EA7B00EA901AD206E01F177245385090C831E0EA04253444946463430010000004B00000000800000425A6831314159265359C831E0EA0000C440C0C800000440000008200030CD00549A9EA7B00EA901AD206E01F177245385090C831E0EA04253444946463430010000006300000000800000425A6831314159265359B2889DFC0000C5D964FE01000140000008400002000040000C200050A600002A4A68069B53DD3152245D20C6E206B3B403359BAFB5BDDDE24057E2EE48A70A12165113BF804253444946463430010000004B00000000800000425A6831314159265359C831E0EA0000C440C0C8000004400000,c3 | CMD为1，差分文件分段编号为0，分段数据<data>的总字节数为1024，2048字节差分文件分段数据，校验码为c3 |
| ←                     | OK                                                           |                                                              |
|                       | ...                                                          | 中间省略写入其它分段差分数据的步骤                           |
| →                     | AT+UARTUPGRADE=2                                             | 验证差分文件                                                 |
| ←                     | +UARTUPGRADE: 6, XOTA_PS_PKG_VERIFIEDOK                      | 通知接收端差分文件验证成功                                   |
| →                     | AT+UARTUPGRADE=5                                             | 升级差分文件                                                 |
| ←                     | OK                                                           |                                                              |
|                       | 升级后大概2分钟左右重新，重启后课通过AT*I查看版本信息，确认模块是否升级成功 |                                                              |
