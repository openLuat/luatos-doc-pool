# Air780E 模块串口电路设计硬件指导

#### 概述

串口作为 Air780E 模块最最主要的通信接口，承担着控制，数据传输，外设通信等重要功能。基本上绝大部分的 Cat.1 应用场景都会用到。而 Air780E 模块的串口特性和使用要求上与通常的 MCU 串口会有些不同，导致在第一次用 Air780E 模块做设计时容易踩到一些坑。本文主要从硬件设计的角度，着重讲解串口设计中的一些关键注意点，LuatOS二次开发或者AT指令设置方面不做深入探讨。

#### 串口相关管脚

Air780E 支持 3 个串口，分别是主串口 MAIN_UART, 扩展串口 AUX_UART, 调试串口 DBG_UART。对应的管脚如下：

| **管脚编号**<br/>       | **管脚名称**<br/> | **描述**<br/>             |
| ----------------------- | ----------------- | ------------------------- |
| 主串口（MAIN_UART)<br/> | <br/>             | <br/>                     |
| 17<br/>                 | MAIN_RXD<br/>     | 串口数据接收<br/>         |
| 18<br/>                 | MAIN_TXD<br/>     | 串口数据发射<br/>         |
| 19<br/>                 | MAIN_DTR*<br/>    | 唤醒中断输入管脚<br/>     |
| 20<br/>                 | MAIN_RI*<br/>     | 振铃信号<br/>             |
| 21<br/>                 | MAIN_DCD*<br/>    | 载波检测*<br/>            |
| 22<br/>                 | MAIN_CTS<br/>     | 模块发送清除（输出）<br/> |
| 23<br/>                 | MAIN_RTS<br/>     | 模块发送请求（输入）<br/> |
| 扩展串口<br/>           | <br/>             | <br/>                     |
| 28<br/>                 | AUX_RXD<br/>      | 扩展串口数据接收<br/>     |
| 29<br/>                 | AUX_TXD<br/>      | 扩展串口数据发射<br/>     |
| 调试串口<br/>           | <br/>             | <br/>                     |
| 38<br/>                 | DBG_RXD<br/>      | 调试串口输入<br/>         |
| 39<br/>                 | DBG_TXD<br/>      | 调试串口输出<br/>         |

> 
> *注： 
> 
> 1，在AT指令使用方式中，MAIN_DTR，MAIN_RI, MAIN_DCD 管脚严格意义来说，并不能归为串口功能，MAIN_DTR，MAIN_RI,是独立的控制功能管脚，MAIN_DCD 目前并无功能，仅仅作为普通 GPIO。
> 
> 2，在LuatOS二次开发中，大家根据需要是将这些管教用作MAIN_UART，还是用作GPIO，这也就是二次开发的灵活之处；

#### 功能描述

- **主串口：**

  模块的 AT 指令控制，数据传输都是通过主串口来实现；
  在LuatOS二次开发时，也建议优先用主串口进行外部通信和模块控制；

  主串口有以下特性：

  - 为 TTL 电平串口（Air780E 所有串口均为 TTL 电平串口），电平为 3.3V/1.8V（默认）电平。（两种串口电平选择，可以通过 pin 100 管脚配置或者二次开发代码配置）。
  - 默认波特率 115200，可以通过 AT+IPR 指令来配置波特率，最大支持 921600 波特率。不支持自适应波特率。
  - 只有主串口支持模块**休眠唤醒功能**（LPUART)。Air780E 模块在休眠时，所有串口均为关闭状态，只有主串口支持接收串口数据唤醒模块。注意，在非 9600 的其他波特率下，进行串口收发数据唤醒时，会丢失前几个字节。

- **扩展串口：**

  扩展串口 AUX_UART 从硬件上的电器特性来说与主串口一样，但不支持休眠唤醒功能，仅用于特定应用，比如外接 GNSS 定位模块；

- **调试串口：**

  调试串口 DBG_UART，用来输出模块的运行日志；

  调试串口固定波特率 961200 不可更改，不能连接任何外设，但建议设计时预留测试点。调试串口日志数据有专门的协议，如果用普通的串口工具抓取会显示乱码，只能使用专用调试工具；

#### 硬件设计指导

- **串口的连接方式：**

  主串口的型号命名很容易让人联想到 RS232 标准的 DB9 接口，其实不然，模块的串口连接方式与标准 RS232 连接方式有所不同，如下是标准 RS232 串口连接方式，特点是交叉连接。
  ![](image/UART-1.png)
  而模块串口遵循的是早期贺氏(HAYES)公司制定的 MODEM 串口标准，在这个标准下，DTR,DSR,CTS,RTS 信号的功能有所不同。MODEM 串口标准标准下 DTR, DSR，CTS，RTS 采用的是直连方式，如下图
  ![](image/UART-2.png)
  在逐渐的演变过程中，DCD ,DSR,RI 逐渐演变为其他的独立功能，在物联网串口应用中仅保留 TX/RX 加流控管脚的 5 线串口的形式，但是 CTS ，RTS 的命名规则保留了下来，虽然 CTS/RTS 采用直连的方式，但是实际上模块的 CTS 管脚起到的功能是标准 RTS 功能；模块 RTS 管脚起到的功能是标准 CTS 功能。连接方式如下：
  ![](image/UART-3.png)

合宙LuatOS二次开发的串口应用，仅支持RX/TX/GND三线串口应用。

- **串口的电平转换：**

Air780E 的串口是 TTL 电平串口，TTL 电平串口会有输入输出判别门限，如下图。

![](image/UART-4.png)

同时，外接 MCU 或者外设的 TTL 电平串口同意有判别门限，一般来说，TTL 电平的判别门限高低取决于 IO 供电电平 VDD 的高低。如果串口双方的判别门限差别较大，一方的输出高电平落在对方的高电平判别门限下，就容易出现误判的现象，虽说 Air780E 可以通过 100 管脚来选择串口电平，但也仅有 1.8V 和 3.3V 两个档位，无法覆盖全部情况，在串口双方电平不一致的情况，就要增加电平转换电路来转换通信电平。

- 双方模块串口电平差别不大的情况：

  例如，模块串口电平 3.3V， MCU 串口电平 3.0V。按照上图判别门限，模块的输入高判别门限为 0.7x3.3=2.32V，所以 MCU 串口高电平输出为 3V，高于模块的输入高判别门限，能够稳定判断。这种情况下即使 MCU 与模块的电平不一致，直接连接也不会造成通信问题。通常这种情况下，无需电平转换，只需要在窗口 TX RX 型号线上串联限流电阻即可，限流电阻用于减小串口电平不匹配造成的漏电，通常按经验串联 1K 电阻即可，注意串联电阻不宜过大，会印象串口型号的上升下降时间，从而影响串口信号质量。
  ![](image/UART-5.png)

> 
> 注意：不要只看判别门限，还要考虑串口的耐压，即使落在判别门限内，但是一方高电平高于对方的 IO 耐压值的情况下就不能要串联电阻的方式，还是老老实实加串口电平转换。一般来说双方的电平差不宜超过 0.5V

- 晶体管的电平转方案：

在串口波特率不高的情况下(如115200)，可以通过 NPN 晶体管的方式进行电平转换，参考设计如下图，这种方式的优点：成本低； 劣势：低电平下会被三极管的饱和管压降抬高（通常在 0.1v 左右，不影响通信）；开关速度不够，超过 460800 波特率时不建议用这种方式。

- 电平转换芯片方案：
  电平转换芯片，对成本不敏感的话，优先考虑用电平转芯片，无论速度，可靠性都很完美。对于设计方面只要注意芯片选型，同时模块端参考电平注意用 AGPIO3，其他的参考具体芯片参考设计即可，没有太多注意事项。

![](image/UART-6.png)

考虑到电平转换芯片价格与通道数量成正相关，也可以采用 TX RX 用双通道电平转换芯片，其他流控信号用晶体管或者分压方式来做电平转换。兼顾性能和成本。

电平转换芯片选型：

#### 总结

虽然串口这个硬件总线原理简单，速率低速，设计也不复杂，但是对于 CAT.1 通信系统尤其是低功耗物联网应用，串口的设计就会牵涉到休眠和功耗，因此在设计中还是要有足够的重视。